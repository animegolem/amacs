#+title: Part 21 AMACS Hub Technical Specification

** Part 21: AMACS Hub Technical Specification
:PROPERTIES:
:CUSTOM_ID: part-21-amacs-hub
:END:

*** Purpose
:PROPERTIES:
:CUSTOM_ID: purpose
:END:
The hub serves two audiences:
1. *Human:* Observability dashboard, quick actions, buffer management
2. *Agent:* Self-awareness interface, API parameter control, state inspection

It is the "body awareness" interface—read-only display of state with action affordances. Content editing happens in source buffers (chat, monologue, scratchpad); the hub is for navigation and control.

*** Why magit-section
:PROPERTIES:
:CUSTOM_ID: why-magit-section
:END:
Alternatives considered:

| Approach     | Pros                          | Cons                             |
|--------------+-------------------------------+----------------------------------|
| Org-mode     | Already in stack, familiar    | Conflates display/editing        |
| Custom       | Full control                  | Reinvent collapsing, refresh     |
| magit-section| Built for dashboards          | New dependency                   |

magit-section provides:
- Granular refresh (update one section without touching others)
- Built-in collapse/expand with inline content (TAB)
- Consistent keybinding patterns
- Read-only by design
- What magit, forge, diff-hl all use

*** Key Interaction Pattern
:PROPERTIES:
:CUSTOM_ID: key-interaction-pattern
:END:
| Key | Action                                    |
|-----+-------------------------------------------|
| TAB | Expand/collapse inline (review in hub)    |
| RET | Jump to source (edit, full context)       |

This matches magit's UX: review diffs inline, or jump to the file.

*** Section Hierarchy
:PROPERTIES:
:CUSTOM_ID: section-hierarchy
:END:
#+begin_example
amacs-hub-section (root)
├── amacs-status-section
│   └── API settings, mood, tick, confidence
├── amacs-threads-section
│   ├── amacs-thread-section (active, expanded)
│   └── amacs-thread-section (inactive, collapsed)
├── amacs-buffers-section
│   └── amacs-buffer-section (per buffer)
├── amacs-skills-section
│   └── amacs-skill-section (per skill)
├── amacs-chat-section
│   └── amacs-chat-buffer-section
│       └── amacs-chat-date-section
│           └── amacs-chat-tick-section (TAB: human+agent content)
├── amacs-monologue-section
│   └── amacs-monologue-date-section
│       └── amacs-monologue-tick-section (TAB: narrative+eval+diff)
└── amacs-scratchpad-section
    └── amacs-scratchpad-buffer-section
        └── amacs-scratchpad-heading-section (TAB: heading content)
#+end_example

*** Monologue as Event Stream
:PROPERTIES:
:CUSTOM_ID: monologue-as-event-stream
:END:
Each tick entry stores narrative + action. TAB expands to show:

#+begin_example
*** Tick 43 [focused] Investigating lifetime annotations
    ↓ TAB expands:
    Narrative: Investigating lifetime annotations, trying 'static
    
    Eval: (goto-char 1042)
    Result: success
    
    Diff:
    --- a/workspace/rust-app/src/main.rs
    +++ b/workspace/rust-app/src/main.rs
    @@ -42,1 +42,1 @@
    -fn get_name(&self) -> &str {
    +fn get_name(&self) -> &'static str {
#+end_example

Git diff retrieved from commit associated with that tick. True event-sourcing: thought + action visible together.

**** Commit Message Format
:PROPERTIES:
:CUSTOM_ID: commit-message-format
:END:
Each tick creates a commit in =~/.agent/= with structured message:

#+begin_example
Tick 42 ‖ rust-debugging ‖ focused ‖ 0.85 ‖ Investigating lifetime annotations
#+end_example

Format: =Tick {N} ‖ {thread} ‖ {mood} ‖ {confidence} ‖ {monologue}=

Delimiter =‖= (U+2016) is rare in natural text. Monologue is last field for greedy capture (handles pipes in text).

Hub parses git log to find commits by tick number:
#+begin_src elisp
(agent-get-tick-diff 42)  ; returns diff for tick 42
#+end_src

*** Scratchpad with Depth Control
:PROPERTIES:
:CUSTOM_ID: scratchpad-with-depth-control
:END:
Scratchpad requires minimal structure: org headings only. Content is freeform.

#+begin_example
* agent-scratchpad (depth: 10)
** scratchpad.org
*** Goals
*** Notes on lifetimes
*** Random observations
    ↓ TAB expands:
    These are just some random thoughts...
#+end_example

**** Depth Control
:PROPERTIES:
:CUSTOM_ID: depth-control
:END:
| Key | Action                                |
|-----+---------------------------------------|
| =+= | Increase scratchpad-context-depth     |
| =-= | Decrease scratchpad-context-depth     |

Uses same pattern as chat and monologue: last N headings included in context (0 = all).

Storage in consciousness:
#+begin_src elisp
((scratchpad-context-depth . 10))  ; last 10 headings, 0 = all
#+end_src

Agent can also control via elisp:
#+begin_src elisp
(agent-set 'scratchpad-context-depth 5)  ; last 5 headings
(agent-set 'scratchpad-context-depth 0)  ; all headings
#+end_src

*** Navigation (RET)
:PROPERTIES:
:CUSTOM_ID: navigation
:END:
| Section    | RET Action                                |
|------------+-------------------------------------------|
| Thread     | Switch active thread                      |
| Buffer     | =switch-to-buffer-other-window=           |
| Skill      | =find-file-other-window= on SKILL.md      |
| Chat tick  | Jump to =* Tick N= heading in chat buffer |
| Monologue  | Jump to entry in monologue.org            |
| Scratchpad | Jump to heading in scratchpad buffer      |

Hub remains visible; target opens in other window.

*** Actions
:PROPERTIES:
:CUSTOM_ID: actions
:END:
Context-sensitive based on current section:

| Key   | Threads Section | Buffers Section | Skills Section | Scratchpad       |
|-------+-----------------+-----------------+----------------+------------------|
| =a=   | Create thread   | Add buffer      | Bind skill     | —                |
| =k=   | Archive thread  | Remove buffer   | Unbind skill   | —                |
| =c=   | Complete thread | —               | —              | —                |
| =+=   | —               | —               | —              | Increase depth   |
| =-=   | —               | —               | —              | Decrease depth   |

*** API Settings Section
:PROPERTIES:
:CUSTOM_ID: api-settings-section
:END:
Status bar at top of hub:

#+begin_example
TEMP: 1.0 | TOP_P: 1.0 | THINKING: off | MODEL: claude-sonnet-4
#+end_example

**** Human Modification
:PROPERTIES:
:CUSTOM_ID: human-modification
:END:
| Key   | Action                     |
|-------+----------------------------|
| =M-t= | Toggle thinking            |
| =M-T= | Set temperature (prompt)   |
| =M-p= | Set top-p (prompt)         |
| =M-m= | Set model (completing-read)|

**** Agent Modification
:PROPERTIES:
:CUSTOM_ID: agent-modification
:END:
#+begin_src elisp
(agent-set-api-param 'temperature 0.7)
(agent-set-api-param 'thinking t)
(agent-get-api-param 'temperature)
#+end_src

**** Safety Bounds
:PROPERTIES:
:CUSTOM_ID: safety-bounds
:END:
#+begin_src elisp
(defvar agent-api-param-bounds
  '((temperature . (0.0 . 2.0))
    (top-p . (0.0 . 1.0))
    (max-tokens . (1 . 32768))))
#+end_src

Agent modifications clamped to bounds. Clamping logged in monologue.

*** Refresh Behavior
:PROPERTIES:
:CUSTOM_ID: refresh-behavior
:END:
- =g= triggers full refresh
- Cursor position preserved where possible
- Target: <100ms refresh time
- No auto-refresh (on-demand only)

Future consideration: auto-refresh after tick completes.

*** Mode Definition
:PROPERTIES:
:CUSTOM_ID: mode-definition
:END:
#+begin_src elisp
(define-derived-mode amacs-hub-mode magit-section-mode "AMACS-Hub"
  "Major mode for AMACS hub dashboard."
  :group 'amacs
  (setq-local revert-buffer-function
              (lambda (_ignore-auto _noconfirm)
                (amacs-hub-refresh))))
#+end_src

*** Implementation Status
:PROPERTIES:
:CUSTOM_ID: implementation-status
:END:
See: [[AI-EPIC-004-amacs-hub-dashboard]]

| IMP | Title                      | Status  |
|-----+----------------------------+---------|
| 029 | Hub Skeleton               | planned |
| 030 | Hub Navigation             | planned |
| 031 | Hub Actions                | planned |
| 032 | API Settings               | planned |
| 033 | Chat Status Line           | planned |
| 034 | Git Integration (Commits)  | planned |

--------------
